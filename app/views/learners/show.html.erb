<div class="main-content courses">
  <ul class="courses-box">
    <li>
      <div class="box">
        <span class="cource-img box-grn">
          <%= image_tag(@course.course_cover_pic.url(:cover)) %>
        </span>
        <span class="cource-disc">
          <ol class="cource-dtl">
            <li>Price<br />
              <span><%= @course.is_paid ? number_to_currency(@course.price, precision: 0) : 'Free' %></span>
            </li>
            <li><%= @course.ratings.count %> Reviews<br/>
              <% if @course.ratings.present? && @course.ratings.find_by_ip_address(request.remote_ip).present? %>
                <div id="course_<%= @course.id %>_rating" class="rateit" data-rateit-resetable="false" data-rateit-value="<%= @course.avg_rating(@course.id) %>" data-rateit-ispreset="true" data-rateit-readonly="true" data-rateit-max="5" data-rateit-min="0" data-rateit-step="1"></div>
              <% else %>
                <div id="course_<%= @course.id %>_rating" class="rateit" data-rateit-resetable="false" data-rateit-value="<%= @course.avg_rating(@course.id) %>" data-rateit-ispreset="true" data-rateit-readonly="false" data-rateit-max="5" data-rateit-min="0" data-rateit-step="1"></div>
              <% end %>
            </li>
            <li>Students<br />
              <span class="sprite students"></span><%= @course.users.where(type: 'Learner').count %>
            </li>
          </ol>
        </span>
      </div>
    </li>
    <li>
      <div class="course-title" style="font-weight: bold; font-size: 12pt;"><%= @course.title.titleize %></div>
      <div class="course-description"><%= raw(@course.description) %></div>
      <div class="course-instructor">
        <% if @course.present? && @course.users.where(type: 'Teacher').present? %>
          <%= @course.users.where(type: 'Teacher').first.full_name.titleize %>
        <% end %>
      </div>
      </br>
      <div class='course-subscribe'>
        <% if current_user.courses.include?(@course) %>
          <%= link_to 'Unsubscribe Course', unsubscribe_course_learner_path(@course), class: 'btn btn-danger' %>
        <% else %>
          <% if @course.is_paid %>
            <%= link_to 'Subscribe Course', new_charge_path(course_id: @course.id, subscription_type: "course_subscription"), class: 'btn btn-primary' %>
          <% else %>
            <%= link_to 'Subscribe Course', subscribe_course_learner_path(@course), class: 'btn btn-primary' %>
          <% end %>
        <% end %>
      </div>
    </li>
  </ul>

  <h2>Course Sections:</h2>
  </br>
  <ul class="nav nav-tabs">
    <% @course.sections.each do |section| %>
      <li>
        <a href="#section_<%= section.id %>" data-toggle="tab">
          <%= section.title.titleize %>
        </a>
      </li>
    <% end %>
  </ul>

  <div class='tab-content'>
    <% @course.sections.each do |section| %>
      <div class="tab-pane" id="section_<%= section.id %>">
        <ul>
          <li>
            <%= raw(section.description) %>
          </li>
          <li class='pull-right' style='margin-left: 1em;'>
            <% if section.unlocked %>
              <b>
                <%= link_to 'Take test', 'javascript:void(0);', class: 'pull-right', target: '_blank' %>
              </b>
            <% end %>
          </li>
          <li class='pull-right'>
            <% if section.unlocked %>
              <b>
                <%= link_to "Download Section", section.attachment.url %>
              </b>
            <% end %>
          </li>
        </ul>
      </div>
    <% end %>
  </div>
</div>

<%= javascript_tag do %>
  $(".rateit").bind('rated', function() {
    obj = $(this);
    $(obj).rateit('readonly', 'readonly');

    $.ajax({
      url: "<%= rate_courses_path %>",
      type: "GET",
      data: {
        course_id: $(obj).attr('id').split('_')[1],
        rate: $(obj).rateit('value')
      }
    });
  });
<% end %>
